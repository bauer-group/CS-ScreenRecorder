# =============================================================================
# Screen Recorder - Coolify PaaS Configuration
# =============================================================================
# Usage: Deploy via Coolify dashboard
#
# COOLIFY HOSTNAME MAPPING:
#   - Cap Web: ${SERVICE_HOSTNAME} (e.g., screenrecorder.app.bauer-group.com) → Port 3000
#   - MinIO S3: ${S3_HOSTNAME} (e.g., assets.screenrecorder.app.bauer-group.com) → Port 9000
#   - MinIO Console: ${S3_CONSOLE_HOSTNAME} (e.g., assets-console.screenrecorder.app.bauer-group.com) → Port 9001
#
# Note: Coolify manages reverse proxy and SSL certificates automatically.
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Cap Web Application
  # ---------------------------------------------------------------------------
  screenrecorder-app:
    image: ghcr.io/bauer-group/cs-screenrecorder/screen-recorder:latest
    restart: unless-stopped
    container_name: SCREENRECORDER_APP
    depends_on:
      mysql-server:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/api/status').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}

      # -- Core Settings --
      - NODE_ENV=${NODE_ENV:-production}
      - WEB_URL=${WEB_URL}
      - NEXTAUTH_URL=${WEB_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}

      # -- Database (static: cap/cap) --
      - DATABASE_URL=mysql://cap:${DATABASE_PASSWORD}@mysql-server:3306/cap

      # -- Encryption --
      - DATABASE_ENCRYPTION_KEY=${DATABASE_ENCRYPTION_KEY:-}

      # -- S3 Storage (static: bucket=videos, user=cap) --
      - CAP_AWS_BUCKET=videos
      - CAP_AWS_REGION=global
      - CAP_AWS_ACCESS_KEY=cap
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
      - S3_PATH_STYLE=true
      - S3_INTERNAL_ENDPOINT=http://minio-server:9000
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT}
      - CAP_AWS_BUCKET_URL=${CAP_AWS_BUCKET_URL}

      # -- Video Settings --
      - CAP_VIDEOS_DEFAULT_PUBLIC=${CAP_VIDEOS_DEFAULT_PUBLIC:-false}
      - CAP_ALLOWED_SIGNUP_DOMAINS=${CAP_ALLOWED_SIGNUP_DOMAINS:-}

      # -- Client Download Redirect --
      - CAP_CLIENT_DOWNLOAD_URL=${CAP_CLIENT_DOWNLOAD_URL:-https://cap.so/download}

      # -- Email (Optional: SMTP or Resend) --
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_TLS=${SMTP_TLS:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_DOMAIN=${RESEND_FROM_DOMAIN:-}

      # -- OAuth (Optional) --
      - AZURE_AD_CLIENT_ID=${AZURE_AD_CLIENT_ID:-}
      - AZURE_AD_CLIENT_SECRET=${AZURE_AD_CLIENT_SECRET:-}
      - AZURE_AD_TENANT_ID=${AZURE_AD_TENANT_ID:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - WORKOS_CLIENT_ID=${WORKOS_CLIENT_ID:-}
      - WORKOS_API_KEY=${WORKOS_API_KEY:-}

      # -- AI Features (Optional) --
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}

      # -- Payments (Optional) --
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}

      # -- Integrations (Optional) --
      - DISCORD_FEEDBACK_WEBHOOK_URL=${DISCORD_FEEDBACK_WEBHOOK_URL:-}
      - DISCORD_LOGS_WEBHOOK_URL=${DISCORD_LOGS_WEBHOOK_URL:-}
      - TINYBIRD_HOST=${TINYBIRD_HOST:-}
      - TINYBIRD_TOKEN=${TINYBIRD_TOKEN:-}
      - DUB_API_KEY=${DUB_API_KEY:-}
      - INTERCOM_SECRET=${INTERCOM_SECRET:-}
      - POSTHOG_PERSONAL_API_KEY=${POSTHOG_PERSONAL_API_KEY:-}

      # -- CDN (Optional) --
      # CloudFront CDN - Only uncomment if you have a valid CloudFront configuration!
      # Empty values cause "DECODER routines::unsupported" errors.
      # - CAP_CLOUDFRONT_DISTRIBUTION_ID=${CAP_CLOUDFRONT_DISTRIBUTION_ID}
      # - CLOUDFRONT_KEYPAIR_ID=${CLOUDFRONT_KEYPAIR_ID}
      # - CLOUDFRONT_KEYPAIR_PRIVATE_KEY=${CLOUDFRONT_KEYPAIR_PRIVATE_KEY}

      # -- Workflows (Optional) --
      - WORKFLOWS_RPC_URL=${WORKFLOWS_RPC_URL:-}
      - WORKFLOWS_RPC_SECRET=${WORKFLOWS_RPC_SECRET:-}

    expose:
      - 3000/tcp
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MySQL Database Server
  # ---------------------------------------------------------------------------
  # Tuned for: 4-8 GB RAM, SSD/NVMe storage
  mysql-server:
    image: mysql:${MYSQL_VERSION:-8.0}
    restart: unless-stopped
    container_name: SCREENRECORDER_DATABASE
    command: >
      --max_connections=${DATABASE_POOL_SIZE:-100}
      --innodb_buffer_pool_size=1G
      --innodb_redo_log_capacity=512M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      --innodb_io_capacity=2000
      --innodb_io_capacity_max=4000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=8
      --innodb_file_per_table=1
      --innodb_open_files=4000
      --table_open_cache=4000
      --table_definition_cache=2000
      --thread_cache_size=50
      --sort_buffer_size=4M
      --read_buffer_size=2M
      --read_rnd_buffer_size=4M
      --join_buffer_size=4M
      --tmp_table_size=64M
      --max_heap_table_size=64M
      --performance_schema=OFF
      --skip-name-resolve
      --log_error_verbosity=2
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MYSQL_DATABASE=cap
      - MYSQL_USER=cap
      - MYSQL_PASSWORD=${DATABASE_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD}
    expose:
      - 3306/tcp
    volumes:
      - 'mysql-data:/var/lib/mysql'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Object Storage Server
  # ---------------------------------------------------------------------------
  minio-server:
    image: quay.io/minio/minio:${MINIO_VERSION:-latest}
    restart: unless-stopped
    container_name: SCREENRECORDER_MINIO
    hostname: minio-server
    command: server --address ":9000" --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 4
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_API_CORS_ALLOW_ORIGIN=*
    expose:
      - 9000/tcp
      - 9001/tcp
    volumes:
      - 'minio-data:/data'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Setup (creates bucket and service user on first start)
  # ---------------------------------------------------------------------------
  minio-setup:
    image: quay.io/minio/mc:latest
    container_name: SCREENRECORDER_MINIO_SETUP
    depends_on:
      minio-server:
        condition: service_healthy
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e

        echo '=== MinIO Setup for Screen Recorder ==='
        echo 'Waiting for MinIO to be ready...'
        sleep 5

        echo 'Configuring MinIO client...'
        mc alias set minio http://minio-server:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"

        echo 'Ensuring bucket exists...'
        mc mb --ignore-existing minio/videos

        echo 'Setting bucket policy to allow public read for video playback...'
        mc anonymous set download minio/videos || true

        echo 'Ensuring service user exists...'
        mc admin user info minio cap >/dev/null 2>&1 || \
        mc admin user add minio cap "$CAP_AWS_SECRET_KEY"

        echo 'Creating bucket access policy for service user...'
        cat > /tmp/cap-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
              ],
              "Resource": "arn:aws:s3:::videos/*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
              ],
              "Resource": "arn:aws:s3:::videos"
            }
          ]
        }
        EOF

        mc admin policy info minio cap-policy >/dev/null 2>&1 || \
        mc admin policy create minio cap-policy /tmp/cap-policy.json

        mc admin policy attach minio cap-policy --user cap || true
        
        echo '=== MinIO Setup Complete ==='
        mc admin user info minio cap || true
        mc ls minio
    networks:
      local:


# =============================================================================
# Volumes
# =============================================================================
volumes:
  # MySQL database storage
  mysql-data:
    driver: local
    name: screenrecorder-database

  # MinIO object storage
  minio-data:
    driver: local
    name: screenrecorder-storage


# =============================================================================
# Networks
# =============================================================================
networks:
  # Internal network for service communication
  local:
    driver: bridge
    name: SCREENRECORDER
    enable_ipv6: true

# =============================================================================
# Cap Screen Recorder - Development Configuration
# =============================================================================
# Usage: docker compose -f docker-compose.development.yml up -d
#
# This configuration exposes services directly via ports (no Traefik required).
# Includes MySQL and MinIO for local development.
#
# Access:
#   - Cap App: http://localhost:3000
#   - MinIO API: http://localhost:9000
#   - MinIO Console: http://localhost:9001
#   - MySQL: localhost:3306
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Cap Web Application
  # ---------------------------------------------------------------------------
  cap-web:
    # Option 1: Build custom branded image locally
    build:
      context: ./src
      dockerfile: Dockerfile

    # Option 2: Use pre-built branded image from GHCR
    # image: ghcr.io/bauer-group/cs-screenrecording/screen-recording:${CAP_VERSION:-latest}

    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_APP
    depends_on:
      mysql-server:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}

      # -- Core Settings --
      - NODE_ENV=${NODE_ENV:-development}
      - WEB_URL=${WEB_URL:-http://localhost:3000}
      - NEXTAUTH_URL=${WEB_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}

      # -- Database (static: cap/cap) --
      - DATABASE_URL=mysql://cap:${DATABASE_PASSWORD}@mysql-server:3306/cap

      # -- Encryption --
      - DATABASE_ENCRYPTION_KEY=${DATABASE_ENCRYPTION_KEY:-}

      # -- S3 Storage (static: bucket=videos, user=cap, region=global) --
      - CAP_AWS_BUCKET=videos
      - CAP_AWS_REGION=global
      - CAP_AWS_ACCESS_KEY=cap
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
      - S3_PATH_STYLE=true
      - S3_INTERNAL_ENDPOINT=http://minio-server:9000
      - S3_PUBLIC_ENDPOINT=http://localhost:${EXPOSED_MINIO_API_PORT:-9000}
      - CAP_AWS_BUCKET_URL=http://localhost:${EXPOSED_MINIO_API_PORT:-9000}/videos

      # -- Video Settings --
      - CAP_VIDEOS_DEFAULT_PUBLIC=${CAP_VIDEOS_DEFAULT_PUBLIC:-true}
      - CAP_ALLOWED_SIGNUP_DOMAINS=${CAP_ALLOWED_SIGNUP_DOMAINS:-}

      # -- Email (Optional) --
      # If not set, login links will be written to container logs
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_DOMAIN=${RESEND_FROM_DOMAIN:-}

      # -- OAuth (Optional) --
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}

      # -- AI Features (Optional) --
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}

    ports:
      - "${EXPOSED_APP_PORT:-3000}:3000"
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MySQL Database Server
  # ---------------------------------------------------------------------------
  # Development configuration with moderate tuning
  mysql-server:
    image: mysql:${MYSQL_VERSION:-8.0}
    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_MYSQL
    command: >
      --default-authentication-plugin=mysql_native_password
      --max_connections=50
      --innodb_buffer_pool_size=256M
      --innodb_log_file_size=64M
      --innodb_flush_log_at_trx_commit=2
      --skip-name-resolve
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MYSQL_DATABASE=cap
      - MYSQL_USER=cap
      - MYSQL_PASSWORD=${DATABASE_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD}
    ports:
      - "${EXPOSED_MYSQL_PORT:-3306}:3306"
    volumes:
      - 'mysql-data:/var/lib/mysql'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Object Storage Server
  # ---------------------------------------------------------------------------
  minio-server:
    image: quay.io/minio/minio:${MINIO_VERSION:-latest}
    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_MINIO
    hostname: minio-server
    command: server --address ":9000" --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 4
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "${EXPOSED_MINIO_API_PORT:-9000}:9000"
      - "${EXPOSED_MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - 'minio-data:/data'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Setup (creates bucket and service user on first start)
  # ---------------------------------------------------------------------------
  minio-setup:
    image: quay.io/minio/mc:latest
    container_name: ${STACK_NAME:-SCREENRECORDER}_MINIO_SETUP
    depends_on:
      minio-server:
        condition: service_healthy
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo '=== MinIO Setup for Cap Screen Recorder (Development) ==='
        echo 'Waiting for MinIO to be ready...'
        sleep 5

        echo 'Configuring MinIO client...'
        mc alias set minio http://minio-server:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD}

        echo 'Creating bucket: videos'
        mc mb --ignore-existing minio/videos

        echo 'Setting bucket policy to allow public read for video playback...'
        mc anonymous set download minio/videos

        echo 'Creating service user: cap'
        mc admin user add minio cap $${CAP_AWS_SECRET_KEY} || true

        echo 'Creating bucket access policy for service user...'
        cat > /tmp/cap-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:ListBucket",
                "s3:GetBucketLocation",
                "s3:ListMultipartUploadParts",
                "s3:AbortMultipartUpload",
                "s3:CreateMultipartUpload",
                "s3:PutObjectAcl"
              ],
              "Resource": [
                "arn:aws:s3:::videos",
                "arn:aws:s3:::videos/*"
              ]
            }
          ]
        }
        EOF
        mc admin policy create minio cap-policy /tmp/cap-policy.json || true
        mc admin policy attach minio cap-policy --user cap || true

        echo ''
        echo '=== MinIO Setup Complete ==='
        mc admin user list minio
        mc ls minio
    networks:
      local:


# =============================================================================
# Volumes
# =============================================================================
volumes:
  # MySQL database storage
  mysql-data:
    driver: local
    name: ${STACK_NAME:-SCREENRECORDER}-database

  # MinIO object storage
  minio-data:
    driver: local
    name: ${STACK_NAME:-SCREENRECORDER}-storage


# =============================================================================
# Networks
# =============================================================================
networks:
  # Internal network for service communication
  local:
    driver: bridge
    name: ${STACK_NAME:-SCREENRECORDER}

# =============================================================================
# Screen Recorder - Development Configuration
# =============================================================================
# Usage: docker compose -f docker-compose.development.yml up -d
#
# This configuration exposes services directly via ports (no Traefik required).
# Includes MySQL and MinIO for local development.
#
# Access:
#   - Cap App: http://localhost:3000
#   - MinIO API: http://localhost:9000
#   - MinIO Console: http://localhost:9001
#   - MySQL: localhost:3306
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Cap Web Application
  # ---------------------------------------------------------------------------
  screenrecorder-app:
    # Option 1: Build custom branded image locally
    build:
      context: ./src
      dockerfile: Dockerfile
      args:
        CAP_VERSION: ${CAP_VERSION:-cap-v0.4.1}

    # Option 2: Use pre-built branded image from GHCR
    # image: ghcr.io/bauer-group/cs-screenrecorder/screen-recorder:latest

    # Option 3: Use official Cap image from GHCR
    # image: ghcr.io/capsoftware/cap-web:latest

    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_APP
    depends_on:
      mysql-server:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/api/status').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      # -- Debugging --
      - NODE_ENV=development
      - DEBUG=*
      - LOG_LEVEL=debug
      - NEXT_DEBUG=true
      # AWS SDK v3 debugging
      - AWS_SDK_LOG_LEVEL=debug
      - AWS_SDK_JS_SUPPRESS_MAINTENANCE_MODE_MESSAGE=1
      # Node.js debugging
      - NODE_DEBUG=*
      - NODE_OPTIONS=--enable-source-maps --trace-warnings --trace-uncaught
      # Effect-TS debugging
      - EFFECT_LOG_LEVEL=All
      - EFFECT_TRACE=1
      # Next.js verbose
      - NEXT_TELEMETRY_DISABLED=1

      # -- Time Zone --
      - TZ=${TIME_ZONE:-Etc/UTC}

      # -- Core Settings (hardcoded for local development) --
      # - NODE_ENV=${NODE_ENV:-development}
      - WEB_URL=http://localhost:${EXPOSED_APP_PORT:-3000}
      - NEXTAUTH_URL=http://localhost:${EXPOSED_APP_PORT:-3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}

      # -- Database (static: cap/cap) --
      - DATABASE_URL=mysql://cap:${DATABASE_PASSWORD}@mysql-server:3306/cap

      # -- Encryption --
      - DATABASE_ENCRYPTION_KEY=${DATABASE_ENCRYPTION_KEY:-}

      # -- S3 Storage (static: bucket=media, user=cap) --
      - CAP_AWS_BUCKET=media
      - CAP_AWS_REGION=${AWS_S3_REGION:-global}
      - CAP_AWS_ACCESS_KEY=cap
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
      - S3_PATH_STYLE=true
      - S3_INTERNAL_ENDPOINT=http://minio-server:9000
      - S3_PUBLIC_ENDPOINT=http://localhost:${EXPOSED_MINIO_API_PORT:-9000}
      - CAP_AWS_BUCKET_URL=http://localhost:${EXPOSED_MINIO_API_PORT:-9000}/media

      # -- Video Settings --
      - CAP_VIDEOS_DEFAULT_PUBLIC=${CAP_VIDEOS_DEFAULT_PUBLIC:-false}
      - CAP_ALLOWED_SIGNUP_DOMAINS=${CAP_ALLOWED_SIGNUP_DOMAINS:-}

      # -- Client Download Redirect --
      - CAP_CLIENT_DOWNLOAD_URL=${CAP_CLIENT_DOWNLOAD_URL:-https://cap.so/download}

      # -- Email (Optional: SMTP or Resend) --
      # If not set, login links will be written to container logs
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_TLS=${SMTP_TLS:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_DOMAIN=${RESEND_FROM_DOMAIN:-}

      # -- OAuth (Optional) --
      - AZURE_AD_CLIENT_ID=${AZURE_AD_CLIENT_ID:-}
      - AZURE_AD_CLIENT_SECRET=${AZURE_AD_CLIENT_SECRET:-}
      - AZURE_AD_TENANT_ID=${AZURE_AD_TENANT_ID:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}

      # -- AI Features (Optional) --
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}

      # Note: For additional features (Payments, Integrations, CDN, Workflows),
      # see docker-compose.traefik.yml or docker-compose.coolify.yml

    ports:
      - "${EXPOSED_APP_PORT:-3000}:3000"
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MySQL Database Server
  # ---------------------------------------------------------------------------
  # Development configuration with moderate tuning
  mysql-server:
    image: mysql:${MYSQL_VERSION:-8.4}
    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_MYSQL
    command: >
      --max_connections=50
      --innodb_buffer_pool_size=256M
      --innodb_redo_log_capacity=128M
      --innodb_flush_log_at_trx_commit=2
      --skip-name-resolve
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MYSQL_DATABASE=cap
      - MYSQL_USER=cap
      - MYSQL_PASSWORD=${DATABASE_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD}
    ports:
      - "${EXPOSED_MYSQL_PORT:-3306}:3306"
    volumes:
      - 'mysql-data:/var/lib/mysql'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Object Storage Server
  # ---------------------------------------------------------------------------
  minio-server:
    image: quay.io/minio/minio:${MINIO_VERSION:-latest}
    restart: unless-stopped
    container_name: ${STACK_NAME:-SCREENRECORDER}_MINIO
    hostname: minio-server
    command: server --address ":9000" --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 4
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    environment:
      - TZ=${TIME_ZONE:-Etc/UTC}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_SITE_REGION=${AWS_S3_REGION:-global}
      - MINIO_API_CORS_ALLOW_ORIGIN=*
    ports:
      - "${EXPOSED_MINIO_API_PORT:-9000}:9000"
      - "${EXPOSED_MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - 'minio-data:/data'
    networks:
      local:


  # ---------------------------------------------------------------------------
  # MinIO Setup (creates bucket and service user on first start)
  # ---------------------------------------------------------------------------
  minio-setup:
    image: quay.io/minio/mc:latest
    container_name: ${STACK_NAME:-SCREENRECORDER}_MINIO_SETUP
    depends_on:
      minio-server:
        condition: service_healthy
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - CAP_AWS_SECRET_KEY=${CAP_AWS_SECRET_KEY}
      - MINIO_REGION=${AWS_S3_REGION:-global}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e

        echo '=== MinIO Setup for Screen Recorder ==='

        echo 'Waiting for MinIO to be ready...'
        until mc alias set minio http://minio-server:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD" 2>/dev/null; do
          echo '  MinIO not ready yet, retrying in 2s...'
          sleep 2
        done
        echo 'MinIO is ready!'

        echo 'Ensuring bucket exists...'
        mc mb --ignore-existing minio/media

        echo 'Setting bucket policy to allow public read for video playback...'
        mc anonymous set download minio/media || true

        echo 'Ensuring service user with current password...'
        mc admin user remove minio cap 2>/dev/null || true
        mc admin user add minio cap "$CAP_AWS_SECRET_KEY"

        echo 'Creating bucket access policy for service user...'
        cat > /tmp/cap-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
              ],
              "Resource": "arn:aws:s3:::media/*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
              ],
              "Resource": "arn:aws:s3:::media"
            }
          ]
        }
        EOF

        mc admin policy info minio cap-policy >/dev/null 2>&1 || \
        mc admin policy create minio cap-policy /tmp/cap-policy.json

        mc admin policy attach minio cap-policy --user cap || true
        
        echo '=== MinIO Setup Complete ==='
        mc admin user info minio cap || true
        mc ls minio
    networks:
      local:


# =============================================================================
# Volumes
# =============================================================================
volumes:
  # MySQL database storage
  mysql-data:
    driver: local
    name: ${STACK_NAME:-SCREENRECORDER}-database

  # MinIO object storage
  minio-data:
    driver: local
    name: ${STACK_NAME:-SCREENRECORDER}-storage


# =============================================================================
# Networks
# =============================================================================
networks:
  # Internal network for service communication
  local:
    driver: bridge
    name: ${STACK_NAME:-SCREENRECORDER}
